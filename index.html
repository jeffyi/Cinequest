<!doctype html>
<html>

<head>
	<title>Cinequest</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<style type="text/css">

	</style>
	<script>
		
		var proxy = "cinequestProxy.php?";
		var selectedTab = -1;
		var festival;			// the festival object
		var schedules;			// the Cinequest XML schedules file
		var schedule;			// the schedule object
		var filmsDates = {};	// to store lists of films by date 
		
		$(function(){

			getFestival();
			getSchedules();
			if (typeof localStorage['schedule'] != 'undefined')
			{
				schedule = JSON.parse(localStorage['schedule']);
			}

			/*
			$('#index').on('pageshow', function(){
				var img = $('#img-cinequest');
				var width = img.width();
				var maxWidth = img.parent().width();
				if (width > maxWidth)
				{
					img.height(img.height * maxWidth / width);
					img.width(maxWidth);				
				}
						
			});

			$('#img-cinequest').load(function(){
				var img = $('#img-cinequest');
				var width = img.width();
				var maxWidth = img.parent().width();
				if (width > maxWidth)
				{
					img.height(img.height * maxWidth / width);
					img.width(maxWidth);				
				}
			});
			*/

			$('#festival').on('pageinit', function(){

			});

			$('#festival').on('pageshow', function(){
				if (selectedTab == -1 || selectedTab == 0)
				{
					$('#filmsTab').attr('checked', true).checkboxradio('refresh');
					$('#events').hide();
					$('#forums').hide();
					$('#films').show();
					selectedTab = 0;
				}
				else if (selectedTab == 1)
				{
					$('#eventsTab').attr('checked', true).checkboxradio('refresh');
					$('#films').hide();
					$('#forums').hide();
					$('#events').show();
					selectedTab = 1;
				}
				else if (selectedTab == 2)
				{
					$('#forumsTab').attr('checked', true).checkboxradio('refresh');
					$('#events').hide();
					$('#films').hide();
					$('#forums').show();
					selectedTab = 2;
				}
			});

			$('#filmsTab').click(function(){
				$('#events').hide();
				$('#forums').hide();
				$('#films').show();
				selectedTab = 0;
			});
			$('#eventsTab').click(function(){
				$('#films').hide();
				$('#forums').hide();
				$('#events').show();
				selectedTab = 1;
			});
			$('#forumsTab').click(function(){
				$('#events').hide();
				$('#films').hide();
				$('#forums').show();
				selectedTab = 2;
			});

			$('#events').append('<h1>Test 2</h1>');
			$('#forums').append('<h1>Test 3</h1>');

		});

		function getFestival(){
			$.ajax({
				type: "GET",
				url: proxy + "type=festival",
				data: "xml",
				success: function(xml){
					festival = xml;
					localStorage['festival'] = festival;
					console.log('ajax success for festival');
				},
				error: function(xhr){
					console.log('ajax failed for festival:' + xhr.statusText);
				}
			});
		}

		function loadDates(){
			var currentDate = '';
			var dateParts;
			var dateDisplay;
			var count = -1;
			var htmlString = '';
			var tag;
			var nextDate;
			$(schedules).find('schedule').each(function(){
				tag = $(this);
				nextDate = tag.attr('start_time').split(' ')[0];
				if (nextDate !== currentDate)
				{
					dateParts = nextDate.split('-');
					dateDisplay = dateParts[1] + '-' + dateParts[2] + '-' + dateParts[0];
					filmsDates[dateDisplay] = [];
					if (count > 0)
					{
						htmlString += '</a><span class="ui-li-count">' + count + '</span></li>' + '<li><a href="#filmsDates" onclick="listFilms(\'' + dateDisplay + '\')">' + dateDisplay;
					}
					else
					{
						htmlString += '<li><a href="#filmsDates" onclick="listFilms(\'' + dateDisplay + '\')">' + dateDisplay;
					}
					count = 1;
					currentDate = nextDate;
				}
				else
				{
					count++;		
				}
				filmsDates[dateDisplay].push({"id": tag.attr('id'), "pid": tag.attr('program_item_id'), "title": tag.attr('title'), "startTime": tag.attr('start_time'), "endTime": tag.attr('end_time'), "venue": tag.attr('venue')});
			});
			htmlString += '</a><span class="ui-li-count">' + count + '</span></li>';
			$('#list-dates').append(htmlString);
			localStorage['filmsDates'] = JSON.stringify(filmsDates);
			$('#list-dates').listview('refresh');
		}

		function convertTime(h, m){
			if (h < 12)
			{
				return h + ':' + m + ' AM';
			}
			else
			{
				return (h == 12 ? h + ':' + m + ' PM' : h - 12 + ':' + m + ' PM');
			}
		}

		function listFilms(dateString){
			// alert(JSON.parse(localStorage['filmsDates'])[dateString][0]['title']);
			var films = filmsDates[dateString];
			var startTime;
			var endTime;
			var scheduled;
			var htmlString = '';
			for (var i = 0; i < films.length; i++)
			{
				scheduled = false;
				startTime = films[i]['startTime'].split(' ')[1].split(':');
				endTime = films[i]['endTime'].split(' ')[1].split(':');
				if (typeof schedule != 'undefined')
				{
					for (var j = 0; j < schedule['data'].length; j++)
					{
						if (films[i]['id'] == schedule['data'][j]['id'])
						{
							scheduled = true;	
							break;
						}
					}
				}
				htmlString += '<li><a href="#filmDetail" id="' + films[i]['id'] + '"';
				if (scheduled)
				{
					htmlString += ' style="background-color: rgb(195, 225, 245)" ';		
				}
				htmlString += ' onclick="showFilmDetail(\'' + films[i]['pid']  + '\')">' + '<h1>' + films[i]['title']  + '</h1><p><small>' + convertTime(startTime[0], startTime[1]) + ' - ' + convertTime(endTime[0], endTime[1]) + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Venue: ' + films[i]['venue']  + '</small>';
				if (scheduled)
				{
					htmlString += '<span class="schedule"><small><br /><br />(Added to schedule)</small></span>';		
				}
				htmlString += '</p></a><a id="s' + films[i]['id']  + '" onclick="updateScheduleFilms(\'' + films[i]['id']  + '\', \'' + films[i]['pid'] + '\', \'' + films[i]['title'].replace("\\", "\\\\").replace("'", "\\\'") + '\', \'' + films[i]['startTime'] + '\', \'' + films[i]['endTime'] + '\', \'' + films[i]['venue'] + '\')"></a></li>';
			}
			$('#name-filmsDates').html('<h2>Films on ' + dateString  + '</h2>');
			$('#list-filmsDates').html(htmlString);
			$('#list-filmsDates').listview('refresh');
		}

		function showFilmDetail(pid){
			var tag;
			var filmId;
			$(festival).find('program_item').each(function(){
				tag = $(this);
				if (tag.attr('id') == pid)
				{
					filmId = tag.find('film').attr('id');		
				}
			});
			$(festival).find('films').each(function(){
				$(this).find('film').each(function(){
					tag = $(this);
					if (tag.attr('id') == filmId)
					{
						var htmlString = '<div align="center"><h3>' + tag.find('title').text() + '</h3></div><img src="' + tag.find('imageURL').text()  + '" style="max-width: 100%" />';
						htmlString += '<p><small>' + tag.find('description').text() + '</small></p><p><small><strong>Genre: </strong>' + tag.find('genre').text() + '<br /><strong>Director: </strong>' + tag.find('director').text() + '<br /><strong>Producer: </strong>' + tag.find('producer').text() + '<br /><strong>Cinematographer: </strong>' + tag.find('cinematographer').text() + '<br /><strong>Editor: </strong>' + tag.find('editor').text() + '<br /><strong>Cast: </strong>' + tag.find('cast').text() + '<br /><strong>Country: </strong>' + tag.find('country').text() + '<br /><strong>Language: </strong>' + tag.find('language').text() + '</small></p>';
						$('#content-filmDetail').html(htmlString);
						return false;
					}
				});
			});
		}

		function updateScheduleFilms(id, pid, title, startTime, endTime, venue){
			if (updateSchedule(id, pid, title, startTime, endTime, venue) == 1)
			{
				$('#' + id + ' > p').append('<span class="schedule"><small>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Scheduled)</small></span>');
				$('#' + id).css({'background-color': 'rgb(195, 225, 245)'});
			}
			else
			{
				$('#' + id + ' span.schedule').remove();
				$('#' + id).css({'background-color': 'rgba(0, 0, 0, 0)'});
					
			}
		}

		function updateSchedule(id, pid, title, startTime, endTime, venue){
			if (typeof schedule == 'undefined')
			{
				schedule = {"data": [{
					"id": id,
					"pid": pid,
					"title": title,
					"startTime": startTime,
					"endTime": endTime,
					"venue": venue
				}]};
				localStorage['schedule'] = JSON.stringify(schedule);
				return 1;
			}

			for (var i = 0; i < schedule['data'].length; i++)
			{
				if (schedule['data'][i]['id'] == id)
				{
					schedule['data'].splice(i, 1);
					localStorage['schedule'] = JSON.stringify(schedule);
					return 0;
				}
			}

			schedule['data'].push({
				"id": id,
				"pid": pid,
				"title": title,
				"startTime": startTime,
				"endTime": endTime,
				"venue": venue
			});
			localStorage['schedule'] = JSON.stringify(schedule);
			return 1;

		}
		
		function getSchedules(){
			$.ajax({
				type: "GET",
				url: proxy + "type=schedules",
				data: "xml",
				success: function(xml){
					schedules = xml;
					localStorage['schedules'] = xml;
					console.log('ajax success for schedules');
					loadDates();
				},
				error: function(xhr){
					console.log('ajax failed for schedules' + xhr.statusText);		
				}
			});
		}



	</script>
</head>

<body>
<!-- Index page -->
	<div data-role="page" id="index" data-title="Cinequest - Home" >

		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>Cinequest</h1>
			<a href="#schedule" class="ui-btn-right" data-icon="grid" data-iconpos="right">Schedule</a>
			<div data-role="navbar">
				<ul>
					<li><a class="ui-btn-active ui-state-persist">Home</a></li>
					<li><a href="#festival">Festival</a></li>
					<li><a href="#dvds">DVDs</a></li>
				</ul>
			</div>
		</div>

		<div data-role="content">
			<div align="center">
				<img id="img-cinequest" src="img/creative.gif" style="max-width: 100%" />
			</div>
		</div>

	</div>

<!-- Festival page -->
	<div data-role="page" id="festival" data-title="Cinequest - Festival" >

		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>Cinequest</h1>
			<a href="#schedule" class="ui-btn-right" data-icon="grid" data-iconpos="right">Schedule</a>
			<div data-role="navbar">
				<ul>
					<li><a href="#index">Home</a></li>
					<li><a class="ui-btn-active ui-state-persist">Festival</a></li>
					<li><a href="#dvds">DVDs</a></li>
				</ul>
			</div>
		</div>
		
		<div data-role="content">
			<div data-role="controlgroup" data-type="horizontal" align="center">
				<label for="filmsTab">Films</label>
				<input type="radio" id="filmsTab" name="festival-tabs" />
				<label for="eventsTab">Events</label>
				<input type="radio" id="eventsTab" name="festival-tabs" />
				<label for="forumsTab">Forums</label>
				<input type="radio" id="forumsTab" name="festival-tabs" />
			</div>

		<!-- Films page -->
			<div id="films">
				<br />
				<ul id="list-dates" data-role="listview" data-inset="true">
					
				</ul>
			</div>

		<!-- Events page -->
			<div id="events" style="display:none">

			</div>

		<!-- Forums page -->
			<div id="forums" style="display:none">

			</div>



		</div>

	</div>

<!-- DVDs page -->
	<div data-role="page" id="dvds" data-title="Cinequest - DVDs" >

		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>Cinequest</h1>
			<a href"#schedule" class="ui-btn-right" data-icon="grid" data-iconpos="right">Schedule</a>
			<div data-role="navbar">
				<ul>
					<li><a href="#index">Home</a></li>
					<li><a href="#festival">Festival</a></li>
					<li><a class="ui-btn-active ui-state-persist">DVDs</a></li>
				</ul>
			</div>
		</div>

		<div data-role="content">
			
		</div>

	</div>

<!-- FilmsDates page -->
	<div data-role="page" id="filmsDates" data-add-back-btn="true">
		
		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>Cinequest</h1>
			<a href="#schedule" class="ui-btn-right" data-icon="grid" data-iconpos="right">Schedule</a>
		</div>

		<div data-role="content">
			<div id="name-filmsDates" align="center">

			</div>

			<ul id="list-filmsDates" data-role="listview" data-split-icon="grid" data-filter="true" data-split-theme="a">

			</ul>
		</div>

	</div>

<!-- FilmDetail page -->
	<div data-role="page" id="filmDetail" data-add-back-btn="true">
		
		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>Cinequest</h1>
			<a href="#schedule" class="ui-btn-right" data-icon="grid" data-iconpos="right">Schedule</a>
		</div>

		<div id="content-filmDetail" data-role="content">
			
		</div>

	</div>

<!-- Schedule page -->
	<div data-role="page" id="schedule" data-add-back-btn="true">
		
		<div data-role="header" data-id="mainheader" data-position="fixed" data-tap-toggle="false">
			<h1>My Cinequest<br /> Schedule</h1>
		</div>

		<div data-role="content">
			
		</div>
		
	</div>


</body>

</html>






















































